# Security Vulnerability Management

This document describes the automated security vulnerability checking and fixing
process for the Gemini CLI project.

## Overview

The project includes automated tools and workflows to detect and fix security
vulnerabilities in npm dependencies. These tools help maintain the security of
the project by regularly checking for known vulnerabilities and attempting to
fix them automatically.

## Automated Checks

### GitHub Actions Workflow

A GitHub Actions workflow runs automatically to check for security
vulnerabilities:

- **Schedule**: Every Monday at 9:00 AM UTC
- **On Pull Requests**: When `package.json` or `package-lock.json` files are
  modified
- **Manual Trigger**: Can be triggered manually via workflow dispatch

The workflow:

1. Checks for vulnerabilities using `npm audit`
2. Attempts to fix them automatically using `npm audit fix`
3. Reports results in the GitHub Actions summary
4. Comments on pull requests if vulnerabilities are found
5. Fails if vulnerabilities cannot be automatically fixed

### Local Scripts

Two npm scripts are available for local use:

#### Check for Vulnerabilities

```bash
npm run check:vulnerabilities
```

This command checks for security vulnerabilities without making any changes.

**Output**:

- ✅ If no vulnerabilities are found, exits with code 0
- ⚠️ If vulnerabilities are found, displays a summary and exits with code 1

#### Fix Vulnerabilities

```bash
npm run fix:vulnerabilities
```

This command checks for vulnerabilities and attempts to fix them automatically
using `npm audit fix`.

**Output**:

- ✅ If all vulnerabilities are fixed, exits with code 0
- ⚠️ If some vulnerabilities remain, displays information about manual fixes
  needed

#### Advanced Usage

For vulnerabilities that require breaking changes:

```bash
node scripts/check-and-fix-vulnerabilities.js --force
```

⚠️ **Warning**: The `--force` flag will install breaking changes. Use with
caution and thoroughly test afterwards.

## Manual Vulnerability Management

If automated fixes are not sufficient:

1. **Review the audit report**:

   ```bash
   npm audit
   ```

2. **Check which packages are affected**:

   ```bash
   npm audit --json
   ```

3. **Try to update specific packages**:

   ```bash
   npm update <package-name>
   ```

4. **For breaking changes, manually update**:
   - Review the changelog of the affected package
   - Update `package.json` manually if needed
   - Run tests to ensure compatibility
   - Update code if breaking changes affect functionality

5. **If no fix is available**:
   - Check if there's an alternative package
   - Consider temporarily accepting the risk (document the decision)
   - Watch for upstream fixes

## Best Practices

1. **Regular Monitoring**: Check the weekly security reports in GitHub Actions

2. **Quick Response**: Address security vulnerabilities promptly, especially
   high and critical severity issues

3. **Test After Fixes**: Always run the test suite after applying security
   fixes:

   ```bash
   npm run preflight
   ```

4. **Review Changes**: Review the changes to `package-lock.json` before
   committing, especially after using `--force`

5. **Document Decisions**: If you choose not to fix a vulnerability (e.g., it
   doesn't affect your usage), document the decision

## Integration with CI/CD

The security check is integrated into the project's CI/CD pipeline:

- All pull requests that modify dependencies are automatically checked
- The build fails if vulnerabilities cannot be automatically fixed
- This ensures that new vulnerabilities are not introduced into the main branch

## Troubleshooting

### "npm audit fix" doesn't fix all vulnerabilities

Some vulnerabilities require breaking changes or are not yet fixed upstream. In
these cases:

1. Check if using `--force` would fix them (use with caution)
2. Review if the vulnerability affects your usage
3. Consider alternative packages
4. Wait for upstream fixes

### False Positives

Sometimes npm audit reports vulnerabilities that don't affect your usage:

1. Review the vulnerability details carefully
2. Check if the vulnerable code path is used in your project
3. Document why it's safe to ignore (if applicable)
4. Consider using `npm audit` overrides (npm 8.3+) for unavoidable false
   positives

## Additional Resources

- [npm audit documentation](https://docs.npmjs.com/cli/v8/commands/npm-audit)
- [GitHub Security Advisories](https://github.com/advisories)
- [National Vulnerability Database](https://nvd.nist.gov/)

## Related Files

- `.github/workflows/security-check.yml` - GitHub Actions workflow
- `scripts/check-and-fix-vulnerabilities.js` - Automation script
- `package.json` - npm scripts configuration
