name: 'Release: Nightly'

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  # Provide GEMINI_API_KEY to all jobs from repository secrets
  GEMINI_API_KEY: '${{ secrets.GEMINI_API_KEY }}'

jobs:
  nightly-release:
    runs-on: 'ubuntu-latest'

    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@v4'

      - name: 'Ensure required secrets'
        id: 'check-secrets'
        run: |
          echo "Checking required environment variables and secrets..."
          if [ -z "${GEMINI_API_KEY}" ]; then
            echo "ERROR: GEMINI_API_KEY is not set. Please add a repository secret named 'GEMINI_API_KEY'."
            echo "To add: Settings -> Secrets and variables -> Actions -> New repository secret"
            exit 1
          fi
          echo "OK: GEMINI_API_KEY present"

      - name: 'Setup Node.js'
        uses: 'actions/setup-node@v4'
        with:
          node-version: '20'

      - name: 'Install dependencies'
        run: |
          npm ci

      - name: 'Run tests'
        env:
          GEMINI_API_KEY: '${{ secrets.GEMINI_API_KEY }}'
        run: |
          npm test -- --runInBand

      - name: 'Build'
        run: |
          npm run build

      - name: 'Create issue on failure (guarded)'
        if: 'always()'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          DETAILS_URL: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          RELEASE_TAG: '${{ env.RELEASE_TAG || ''nightly'' }}'
        run: |
          # Check whether repository allows issues
          has_issues=$(gh api repos/${GITHUB_REPOSITORY} -q .has_issues 2>/dev/null || echo "false")
          echo "Repository has_issues=${has_issues}"

          if [ "${has_issues}" != "true" ]; then
            echo "Repository has issues disabled — skipping issue creation."
            exit 0
          fi

          # Only create issue when job failed or was cancelled
          if [ "${{ job.status }}" = "failure" ] || [ "${{ job.status }}" = "cancelled" ]; then
            echo "Creating issue for failed nightly release..."
            gh issue create --title "Nightly Release Failed for ${RELEASE_TAG} on $(date +'%Y-%m-%d')" \
              --body "The nightly-release workflow failed. See the full run for details: ${DETAILS_URL}" \
              --label 'kind/bug,release-failure,priority/p0' || echo "gh issue create failed but will not fail workflow"
          else
            echo "Job succeeded — not creating an issue."
          fi
