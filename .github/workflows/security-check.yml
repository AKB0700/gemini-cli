name: 'Security: Vulnerability Check'

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  pull_request:
    branches:
      - 'main'
      - 'release/**'
    paths:
      - 'package.json'
      - 'package-lock.json'
      - '**/package.json'
      - '**/package-lock.json'
  workflow_dispatch:

permissions:
  contents: 'read'
  issues: 'write'
  pull-requests: 'write'

defaults:
  run:
    shell: 'bash'

jobs:
  check-vulnerabilities:
    name: 'Check npm vulnerabilities'
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8' # ratchet:actions/checkout@v5

      - name: 'Set up Node.js'
        uses: 'actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020' # ratchet:actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: 'Install dependencies'
        run: 'npm ci'

      - name: 'Check for vulnerabilities'
        id: 'vuln-check'
        run: |
          set +e
          npm run check:vulnerabilities
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "No vulnerabilities found"
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
          else
            echo "Vulnerabilities detected"
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
          fi
          
          exit $EXIT_CODE
        continue-on-error: true

      - name: 'Attempt to fix vulnerabilities'
        if: steps.vuln-check.outputs.has_vulnerabilities == 'true'
        id: 'fix-attempt'
        run: |
          set +e
          npm run fix:vulnerabilities
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "Vulnerabilities fixed successfully"
            echo "fixed=true" >> $GITHUB_OUTPUT
          else
            echo "Could not fix all vulnerabilities automatically"
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi

      - name: 'Generate vulnerability report'
        if: steps.vuln-check.outputs.has_vulnerabilities == 'true'
        id: 'report'
        run: |
          npm audit --json > audit-report.json || true
          
          # Create a markdown summary
          cat > vulnerability-summary.md << 'EOF'
          ## üîí Security Vulnerability Report
          
          EOF
          
          if [ "${{ steps.fix-attempt.outputs.fixed }}" == "true" ]; then
            cat >> vulnerability-summary.md << 'EOF'
          ‚úÖ All vulnerabilities were automatically fixed using \`npm audit fix\`.
          
          ### Recommendation
          - Review the changes to package-lock.json
          - Run tests to ensure nothing broke
          - Commit and merge the fixes
          
          EOF
          else
            cat >> vulnerability-summary.md << 'EOF'
          ‚ö†Ô∏è  Some vulnerabilities could not be automatically fixed.
          
          ### Manual Action Required
          These vulnerabilities may require:
          - Updating to a breaking version of a dependency
          - Finding alternative packages
          - Waiting for upstream fixes
          
          Run \`npm audit\` locally for detailed information.
          
          EOF
          fi
          
          cat >> vulnerability-summary.md << 'EOF'
          ### Audit Results
          ```
          EOF
          npm audit >> vulnerability-summary.md || true
          cat >> vulnerability-summary.md << 'EOF'
          ```
          
          ---
          
          üí° **Tip**: You can run \`npm run check:vulnerabilities\` locally to check for vulnerabilities,
          or \`npm run fix:vulnerabilities\` to automatically fix them.
          EOF
          
          cat vulnerability-summary.md >> $GITHUB_STEP_SUMMARY

      - name: 'Comment on PR (if applicable)'
        if: |
          github.event_name == 'pull_request' && 
          steps.vuln-check.outputs.has_vulnerabilities == 'true'
        uses: 'actions/github-script@v7'
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('vulnerability-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: 'Fail if vulnerabilities remain'
        if: |
          steps.vuln-check.outputs.has_vulnerabilities == 'true' && 
          steps.fix-attempt.outputs.fixed != 'true'
        run: |
          echo "‚ùå Security vulnerabilities detected that could not be automatically fixed."
          echo "Please review the audit report and fix manually."
          exit 1
